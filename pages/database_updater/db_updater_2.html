<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>D&D Campaign Manager</title>
		<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
		<style>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}

			body {
				font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
				background: linear-gradient(135deg, #1e1e2e 0%, #2d2d44 100%);
				color: #e0e0e0;
				min-height: 100vh;
				padding: 20px;
			}

			.container {
				max-width: 1400px;
				margin: 0 auto;
			}

			header {
				background: rgba(255, 255, 255, 0.05);
				backdrop-filter: blur(10px);
				padding: 20px 30px;
				border-radius: 12px;
				margin-bottom: 30px;
				border: 1px solid rgba(255, 255, 255, 0.1);
			}

			h1 {
				color: #fff;
				font-size: 2em;
				margin-bottom: 10px;
			}

			.config-section {
				background: rgba(255, 100, 100, 0.1);
				border: 1px solid rgba(255, 100, 100, 0.3);
				padding: 15px;
				border-radius: 8px;
				margin-top: 15px;
			}

			.config-section input {
				width: 100%;
				padding: 8px;
				margin: 5px 0;
				background: rgba(0, 0, 0, 0.3);
				border: 1px solid rgba(255, 255, 255, 0.2);
				border-radius: 4px;
				color: #fff;
				font-size: 0.9em;
			}

			.config-section button {
				background: #4caf50;
				color: white;
				border: none;
				padding: 10px 20px;
				border-radius: 4px;
				cursor: pointer;
				margin-top: 10px;
			}

			.config-section button:hover {
				background: #45a049;
			}

			.tabs {
				display: flex;
				gap: 10px;
				margin-bottom: 20px;
				flex-wrap: wrap;
			}

			.tab {
				padding: 12px 24px;
				background: rgba(255, 255, 255, 0.05);
				border: 1px solid rgba(255, 255, 255, 0.1);
				border-radius: 8px;
				cursor: pointer;
				transition: all 0.3s;
				font-weight: 500;
			}

			.tab:hover {
				background: rgba(255, 255, 255, 0.1);
				border-color: rgba(255, 255, 255, 0.2);
			}

			.tab.active {
				background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
				border-color: #667eea;
				color: white;
			}

			.content-area {
				background: rgba(255, 255, 255, 0.05);
				backdrop-filter: blur(10px);
				padding: 30px;
				border-radius: 12px;
				border: 1px solid rgba(255, 255, 255, 0.1);
			}

			.form-grid {
				display: grid;
				grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
				gap: 20px;
				margin-bottom: 20px;
			}

			.form-group {
				display: flex;
				flex-direction: column;
			}

			label {
				margin-bottom: 8px;
				color: #b0b0b0;
				font-size: 0.9em;
				font-weight: 500;
			}

			input,
			select,
			textarea {
				padding: 12px;
				background: rgba(0, 0, 0, 0.3);
				border: 1px solid rgba(255, 255, 255, 0.2);
				border-radius: 6px;
				color: #fff;
				font-size: 1em;
				transition: all 0.3s;
			}

			input:focus,
			select:focus,
			textarea:focus {
				outline: none;
				border-color: #667eea;
				background: rgba(0, 0, 0, 0.4);
			}

			textarea {
				min-height: 120px;
				resize: vertical;
				font-family: inherit;
			}

			.full-width {
				grid-column: 1 / -1;
			}

			button {
				padding: 14px 28px;
				background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
				color: white;
				border: none;
				border-radius: 8px;
				cursor: pointer;
				font-size: 1em;
				font-weight: 600;
				transition: all 0.3s;
				margin-top: 10px;
			}

			button:hover {
				transform: translateY(-2px);
				box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
			}

			button:active {
				transform: translateY(0);
			}

			.message {
				padding: 15px;
				border-radius: 8px;
				margin-bottom: 20px;
				display: none;
			}

			.message.success {
				background: rgba(76, 175, 80, 0.2);
				border: 1px solid rgba(76, 175, 80, 0.5);
				color: #4caf50;
			}

			.message.error {
				background: rgba(244, 67, 54, 0.2);
				border: 1px solid rgba(244, 67, 54, 0.5);
				color: #f44336;
			}

			.reference-select {
				position: relative;
			}

			.reference-options {
				position: absolute;
				top: 100%;
				left: 0;
				right: 0;
				background: #2d2d44;
				border: 1px solid rgba(255, 255, 255, 0.2);
				border-radius: 6px;
				max-height: 200px;
				overflow-y: auto;
				z-index: 1000;
				display: none;
				margin-top: 4px;
			}

			.reference-options.show {
				display: block;
			}

			.reference-option {
				padding: 10px;
				cursor: pointer;
				border-bottom: 1px solid rgba(255, 255, 255, 0.1);
			}

			.reference-option:hover {
				background: rgba(255, 255, 255, 0.1);
			}

			.hidden {
				display: none;
			}

			.loading {
				text-align: center;
				padding: 20px;
				color: #667eea;
			}

			.help-text {
				font-size: 0.85em;
				color: #888;
				margin-top: 4px;
			}

			.json-editor {
				font-family: 'Courier New', monospace;
				background: rgba(0, 0, 0, 0.5);
			}

			.campaign-selector {
				margin-bottom: 20px;
				padding: 15px;
				background: rgba(255, 255, 255, 0.05);
				border-radius: 8px;
			}

			.campaign-selector select {
				width: 100%;
				max-width: 400px;
			}

			.multi-select-container {
				display: flex;
				gap: 10px;
				align-items: flex-start;
			}

			.multi-select-container select {
				flex: 1;
			}

			.multi-select-container button {
				padding: 12px 20px;
				margin-top: 0;
			}

			.selected-items {
				display: flex;
				flex-wrap: wrap;
				gap: 8px;
				margin-top: 10px;
			}

			.selected-item {
				background: rgba(102, 126, 234, 0.3);
				padding: 6px 12px;
				border-radius: 20px;
				display: flex;
				align-items: center;
				gap: 8px;
			}

			.selected-item button {
				background: none;
				border: none;
				color: #fff;
				cursor: pointer;
				padding: 0;
				margin: 0;
				font-size: 1.2em;
				line-height: 1;
			}
		</style>
	</head>
	<body>
		<div class="container">
			<header>
				<h1>üé≤ D&D Campaign Manager</h1>
				<p>Easily add campaigns, sessions, NPCs, locations, and more to your database</p>

				<div class="config-section" id="configSection">
					<h3>‚öôÔ∏è Supabase Configuration</h3>
					<p style="font-size: 0.9em; margin-bottom: 10px">Enter your Supabase credentials to connect:</p>
					<input
						type="text"
						id="supabaseUrl"
						placeholder="Supabase URL (e.g., https://xxx.supabase.co)"
						value="https://yffukfulnggfhlgoyowg.supabase.co" />
					<input
						type="password"
						id="supabaseKey"
						placeholder="Supabase Anon Key"
						value="sb_publishable_AX2-qMjR0Jigxgcc3UET1g_YYBTaBUz" />
					<button onclick="connectSupabase()">Connect to Database</button>
				</div>
			</header>

			<div id="mainContent" class="hidden">
				<div class="campaign-selector">
					<label for="campaignSelect"><strong>Select Active Campaign:</strong></label>
					<select id="campaignSelect" onchange="handleCampaignChange()">
						<option value="">-- Select a campaign --</option>
					</select>
				</div>

				<div class="tabs">
					<div class="tab active" onclick="switchTab('campaigns')">Campaigns</div>
					<div class="tab" onclick="switchTab('sessions')">Sessions</div>
					<div class="tab" onclick="switchTab('characters')">Characters</div>
					<div class="tab" onclick="switchTab('npcs')">NPCs</div>
					<div class="tab" onclick="switchTab('locations')">Locations</div>
					<div class="tab" onclick="switchTab('factions')">Factions</div>
					<div class="tab" onclick="switchTab('quests')">Quests</div>
					<div class="tab" onclick="switchTab('encounters')">Encounters</div>
					<div class="tab" onclick="switchTab('initiative')">Initiative</div>
					<div class="tab" onclick="switchTab('combat-log')">Combat Log</div>
					<div class="tab" onclick="switchTab('events')">Session Events</div>
				</div>

				<div class="content-area">
					<div id="message" class="message"></div>
					<div id="formContainer"></div>
				</div>
			</div>
		</div>

		<script>
			let supabase = null;
			let currentCampaign = null;
			let allData = {
				campaigns: [],
				sessions: [],
				npcs: [],
				locations: [],
				factions: [],
				quests: [],
				encounters: [],
				characters: [],
				initiative: [],
				rounds: [],
				actions: [],
				consequences: [],
			};

			async function connectSupabase() {
				const url = document.getElementById('supabaseUrl').value.trim();
				const key = document.getElementById('supabaseKey').value.trim();

				if (!url || !key) {
					showMessage('Please enter both URL and API key', 'error');
					return;
				}

				try {
					supabase = window.supabase.createClient(url, key);

					// Test connection
					const { data, error } = await supabase.from('campaigns').select('count');

					if (error) throw error;

					document.getElementById('configSection').style.display = 'none';
					document.getElementById('mainContent').classList.remove('hidden');

					await loadAllData();
					showMessage('Connected successfully!', 'success');
				} catch (error) {
					showMessage('Connection failed: ' + error.message, 'error');
				}
			}

			async function loadAllData() {
				try {
					const [
						campaigns,
						sessions,
						npcs,
						locations,
						factions,
						quests,
						encounters,
						characters,
						initiative,
						rounds,
						actions,
						consequences,
					] = await Promise.all([
						supabase.from('campaigns').select('*'),
						supabase.from('sessions').select('*'),
						supabase.from('npcs').select('*'),
						supabase.from('locations').select('*'),
						supabase.from('factions').select('*'),
						supabase.from('quests').select('*'),
						supabase.from('encounters').select('*'),
						supabase.from('characters').select('*'),
						supabase.from('encounter_initiative').select('*'),
						supabase.from('encounter_rounds').select('*'),
						supabase.from('encounter_actions').select('*'),
						supabase.from('encounter_consequences').select('*'),
					]);

					allData = {
						campaigns: campaigns.data || [],
						sessions: sessions.data || [],
						npcs: npcs.data || [],
						locations: locations.data || [],
						factions: factions.data || [],
						quests: quests.data || [],
						encounters: encounters.data || [],
						characters: characters.data || [],
						initiative: initiative.data || [],
						rounds: rounds.data || [],
						actions: actions.data || [],
						consequences: consequences.data || [],
					};

					updateCampaignSelector();
				} catch (error) {
					console.error('Error loading data:', error);
				}
			}

			function updateCampaignSelector() {
				const select = document.getElementById('campaignSelect');
				select.innerHTML = '<option value="">-- Select a campaign --</option>';

				allData.campaigns.forEach((campaign) => {
					const option = document.createElement('option');
					option.value = campaign.id;
					option.textContent = `Campaign ${campaign.campaign_id}`;
					select.appendChild(option);
				});
			}

			function handleCampaignChange() {
				const select = document.getElementById('campaignSelect');
				currentCampaign = select.value;

				// Refresh current form if applicable
				const activeTab = document.querySelector('.tab.active');
				if (activeTab) {
					const tabName = activeTab.textContent.toLowerCase().trim();
					switchTab(tabName);
				}
			}

			function showMessage(text, type) {
				const msg = document.getElementById('message');
				msg.textContent = text;
				msg.className = `message ${type}`;
				msg.style.display = 'block';

				setTimeout(() => {
					msg.style.display = 'none';
				}, 5000);
			}

			function switchTab(tabName) {
				document.querySelectorAll('.tab').forEach((tab) => {
					tab.classList.remove('active');
					if (tab.textContent.toLowerCase().includes(tabName)) {
						tab.classList.add('active');
					}
				});

				const forms = {
					campaigns: createCampaignForm,
					sessions: createSessionForm,
					characters: createCharacterForm,
					npcs: createNPCForm,
					locations: createLocationForm,
					factions: createFactionForm,
					quests: createQuestForm,
					encounters: createEncounterForm,
					initiative: createInitiativeForm,
					'combat-log': createCombatLogForm,
					events: createEventForm,
				};

				const formContainer = document.getElementById('formContainer');
				formContainer.innerHTML = '';

				if (forms[tabName]) {
					forms[tabName]();
				}
			}

			function createCampaignForm() {
				const container = document.getElementById('formContainer');
				container.innerHTML = `
                <h2>Add New Campaign</h2>
                <form onsubmit="handleSubmit(event, 'campaigns')" id="campaignForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="campaign_id">Campaign ID *</label>
                            <input type="number" id="campaign_id" name="campaign_id" required>
                            <span class="help-text">Unique identifier for this campaign</span>
                        </div>
                        <div class="form-group">
                            <label for="name">Campaign Name *</label>
                            <input type="text" id="name" name="name" required>
                        </div>
                        <div class="form-group full-width">
                            <label for="metadata">Metadata (JSON)</label>
                            <textarea id="metadata" name="metadata" class="json-editor" placeholder='{"setting": "Forgotten Realms"}'></textarea>
                            <span class="help-text">Optional JSON metadata</span>
                        </div>
                        <div class="form-group full-width">
                            <label for="styling">Styling (JSON)</label>
                            <textarea id="styling" name="styling" class="json-editor" placeholder='{"theme": "dark"}'></textarea>
                            <span class="help-text">Optional JSON styling preferences</span>
                        </div>
                    </div>
                    <button type="submit">Create Campaign</button>
                </form>
            `;
			}

			function createSessionForm() {
				if (!currentCampaign) {
					document.getElementById('formContainer').innerHTML = '<p>Please select a campaign first.</p>';
					return;
				}

				const container = document.getElementById('formContainer');
				container.innerHTML = `
                <h2>Add New Session</h2>
                <form onsubmit="handleSubmit(event, 'sessions')" id="sessionForm">
                    <input type="hidden" name="campaign_id" value="${currentCampaign}">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="session_number">Session Number *</label>
                            <input type="number" id="session_number" name="session_number" required>
                        </div>
                        <div class="form-group">
                            <label for="title">Session Title *</label>
                            <input type="text" id="title" name="title" required>
                        </div>
                        <div class="form-group">
                            <label for="session_date">Date *</label>
                            <input type="date" id="session_date" name="session_date" required>
                        </div>
                        <div class="form-group full-width">
                            <label for="summary">Summary</label>
                            <textarea id="summary" name="summary" placeholder="Brief session overview"></textarea>
                        </div>
                        <div class="form-group full-width">
                            <label for="narrative">Narrative</label>
                            <textarea id="narrative" name="narrative" rows="10" placeholder="Full session narrative (4000+ words welcome!)"></textarea>
                        </div>
                    </div>
                    <button type="submit">Create Session</button>
                </form>
            `;
			}

			function createCharacterForm() {
				if (!currentCampaign) {
					document.getElementById('formContainer').innerHTML = '<p>Please select a campaign first.</p>';
					return;
				}

				const container = document.getElementById('formContainer');
				container.innerHTML = `
                <h2>Add New Character</h2>
                <form onsubmit="handleSubmit(event, 'characters')" id="characterForm">
                    <input type="hidden" name="campaign_id" value="${currentCampaign}">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="name">Name *</label>
                            <input type="text" id="name" name="name" required>
                        </div>
                        <div class="form-group">
                            <label for="race">Race</label>
                            <input type="text" id="race" name="race" placeholder="e.g., Human, Elf, Dwarf">
                        </div>
                        <div class="form-group">
                            <label for="class">Class</label>
                            <input type="text" id="class" name="class" placeholder="e.g., Fighter, Wizard">
                        </div>
                        <div class="form-group">
                            <label for="level">Level</label>
                            <input type="number" id="level" name="level" value="1" min="1" max="20">
                        </div>
                        <div class="form-group">
                            <label for="icon">Icon URL</label>
                            <input type="text" id="icon" name="icon" placeholder="https://...">
                        </div>
                        <div class="form-group">
                            <label for="image_bg">Background Image URL</label>
                            <input type="text" id="image_bg" name="image_bg" placeholder="https://...">
                        </div>
                        <div class="form-group full-width">
                            <label for="short_description">Short Description</label>
                            <textarea id="short_description" name="short_description" rows="2"></textarea>
                        </div>
                        <div class="form-group full-width">
                            <label for="background">Background</label>
                            <textarea id="background" name="background" rows="4"></textarea>
                        </div>
                        <div class="form-group full-width">
                            <label for="stats">Stats (JSON)</label>
                            <textarea id="stats" name="stats" class="json-editor" placeholder='{"STR": 16, "DEX": 14, "CON": 15, "INT": 10, "WIS": 12, "CHA": 8}'></textarea>
                        </div>
                        <div class="form-group">
                            <label for="is_active">Active Character?</label>
                            <select id="is_active" name="is_active">
                                <option value="true">Yes</option>
                                <option value="false">No</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit">Create Character</button>
                </form>
            `;
			}

			function createNPCForm() {
				if (!currentCampaign) {
					document.getElementById('formContainer').innerHTML = '<p>Please select a campaign first.</p>';
					return;
				}

				const locationOptions = allData.locations
					.filter((l) => l.campaign_id === currentCampaign)
					.map((l) => `<option value="${l.id}">${l.name}</option>`)
					.join('');

				const factionOptions = allData.factions
					.filter((f) => f.campaign_id === currentCampaign)
					.map((f) => `<option value="${f.id}">${f.name}</option>`)
					.join('');

				const container = document.getElementById('formContainer');
				container.innerHTML = `
                <h2>Add New NPC</h2>
                <form onsubmit="handleSubmit(event, 'npcs')" id="npcForm">
                    <input type="hidden" name="campaign_id" value="${currentCampaign}">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="name">Name *</label>
                            <input type="text" id="name" name="name" required>
                        </div>
                        <div class="form-group">
                            <label for="race">Race</label>
                            <input type="text" id="race" name="race">
                        </div>
                        <div class="form-group">
                            <label for="class">Class</label>
                            <input type="text" id="class" name="class">
                        </div>
                        <div class="form-group">
                            <label for="gender">Gender</label>
                            <input type="text" id="gender" name="gender">
                        </div>
                        <div class="form-group">
                            <label for="affinity">Affinity</label>
                            <select id="affinity" name="affinity">
                                <option value="unknown">Unknown</option>
                                <option value="ally">Ally</option>
                                <option value="neutral">Neutral</option>
                                <option value="enemy">Enemy</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="status">Status</label>
                            <select id="status" name="status">
                                <option value="alive">Alive</option>
                                <option value="dead">Dead</option>
                                <option value="unknown">Unknown</option>
                                <option value="missing">Missing</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="role">Role/Occupation</label>
                            <input type="text" id="role" name="role" placeholder="e.g., Blacksmith, Guard Captain">
                        </div>
                        <div class="form-group">
                            <label for="portrait">Portrait URL</label>
                            <input type="text" id="portrait" name="portrait">
                        </div>
                        <div class="form-group full-width">
                            <label for="description">Description</label>
                            <textarea id="description" name="description" rows="3"></textarea>
                        </div>
                        <div class="form-group full-width">
                            <label for="personality">Personality</label>
                            <textarea id="personality" name="personality" rows="3"></textarea>
                        </div>
                        <div class="form-group full-width">
                            <label for="background">Background</label>
                            <textarea id="background" name="background" rows="3"></textarea>
                        </div>
                    </div>
                    <button type="submit">Create NPC</button>
                    
                    <div style="margin-top: 30px; padding-top: 30px; border-top: 1px solid rgba(255,255,255,0.2);">
                        <h3>Optional: Add Location & Faction</h3>
                        <p style="font-size: 0.9em; margin-bottom: 15px;">You can assign this NPC to locations and factions after creation</p>
                    </div>
                </form>
            `;
			}

			function createLocationForm() {
				if (!currentCampaign) {
					document.getElementById('formContainer').innerHTML = '<p>Please select a campaign first.</p>';
					return;
				}

				const parentOptions = allData.locations
					.filter((l) => l.campaign_id === currentCampaign)
					.map((l) => `<option value="${l.id}">${l.name}</option>`)
					.join('');

				const container = document.getElementById('formContainer');
				container.innerHTML = `
                <h2>Add New Location</h2>
                <form onsubmit="handleSubmit(event, 'locations')" id="locationForm">
                    <input type="hidden" name="campaign_id" value="${currentCampaign}">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="name">Name *</label>
                            <input type="text" id="name" name="name" required>
                        </div>
                        <div class="form-group">
                            <label for="type">Type</label>
                            <select id="type" name="type">
                                <option value="">Select...</option>
                                <option value="city">City</option>
                                <option value="town">Town</option>
                                <option value="village">Village</option>
                                <option value="dungeon">Dungeon</option>
                                <option value="wilderness">Wilderness</option>
                                <option value="plane">Plane</option>
                                <option value="region">Region</option>
                                <option value="landmark">Landmark</option>
                                <option value="building">Building</option>
                                <option value="room">Room</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="parent_location_id">Parent Location</label>
                            <select id="parent_location_id" name="parent_location_id">
                                <option value="">None</option>
                                ${parentOptions}
                            </select>
                            <span class="help-text">e.g., this building is in this city</span>
                        </div>
                        <div class="form-group">
                            <label for="region">Region</label>
                            <input type="text" id="region" name="region">
                        </div>
                        <div class="form-group">
                            <label for="population">Population</label>
                            <input type="text" id="population" name="population" placeholder="e.g., 5,000">
                        </div>
                        <div class="form-group">
                            <label for="ruler">Ruler</label>
                            <input type="text" id="ruler" name="ruler">
                        </div>
                        <div class="form-group">
                            <label for="government_type">Government Type</label>
                            <input type="text" id="government_type" name="government_type">
                        </div>
                        <div class="form-group">
                            <label for="size">Size</label>
                            <input type="text" id="size" name="size">
                        </div>
                        <div class="form-group">
                            <label for="races">Common Races</label>
                            <input type="text" id="races" name="races" placeholder="Human, Elf, Dwarf">
                        </div>
                        <div class="form-group">
                            <label for="natives">Natives</label>
                            <input type="text" id="natives" name="natives">
                        </div>
                        <div class="form-group">
                            <label for="exports">Exports</label>
                            <input type="text" id="exports" name="exports">
                        </div>
                        <div class="form-group">
                            <label for="imports">Imports</label>
                            <input type="text" id="imports" name="imports">
                        </div>
                        <div class="form-group full-width">
                            <label for="description">Description</label>
                            <textarea id="description" name="description" rows="4"></textarea>
                        </div>
                        <div class="form-group full-width">
                            <label for="history">History</label>
                            <textarea id="history" name="history" rows="4"></textarea>
                        </div>
                    </div>
                    <button type="submit">Create Location</button>
                </form>
            `;
			}

			function createFactionForm() {
				if (!currentCampaign) {
					document.getElementById('formContainer').innerHTML = '<p>Please select a campaign first.</p>';
					return;
				}

				const npcOptions = allData.npcs
					.filter((n) => n.campaign_id === currentCampaign)
					.map((n) => `<option value="${n.id}">${n.name}</option>`)
					.join('');

				const container = document.getElementById('formContainer');
				container.innerHTML = `
                <h2>Add New Faction</h2>
                <form onsubmit="handleSubmit(event, 'factions')" id="factionForm">
                    <input type="hidden" name="campaign_id" value="${currentCampaign}">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="name">Faction Name *</label>
                            <input type="text" id="name" name="name" required>
                        </div>
                        <div class="form-group">
                            <label for="type">Type</label>
                            <input type="text" id="type" name="type" placeholder="e.g., Guild, Military, Criminal">
                        </div>
                        <div class="form-group">
                            <label for="leader_npc_id">Leader</label>
                            <select id="leader_npc_id" name="leader_npc_id">
                                <option value="">None</option>
                                ${npcOptions}
                            </select>
                        </div>
                        <div class="form-group full-width">
                            <label for="description">Description</label>
                            <textarea id="description" name="description" rows="5"></textarea>
                        </div>
                    </div>
                    <button type="submit">Create Faction</button>
                </form>
            `;
			}

			function createQuestForm() {
				if (!currentCampaign) {
					document.getElementById('formContainer').innerHTML = '<p>Please select a campaign first.</p>';
					return;
				}

				const container = document.getElementById('formContainer');
				container.innerHTML = `
                <h2>Add New Quest</h2>
                <form onsubmit="handleSubmit(event, 'quests')" id="questForm">
                    <input type="hidden" name="campaign_id" value="${currentCampaign}">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="title">Quest Title *</label>
                            <input type="text" id="title" name="title" required>
                        </div>
                        <div class="form-group">
                            <label for="status">Status</label>
                            <select id="status" name="status">
                                <option value="active">Active</option>
                                <option value="completed">Completed</option>
                                <option value="failed">Failed</option>
                                <option value="on-hold">On Hold</option>
                                <option value="abandoned">Abandoned</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="priority">Priority</label>
                            <select id="priority" name="priority">
                                <option value="medium">Medium</option>
                                <option value="low">Low</option>
                                <option value="high">High</option>
                                <option value="urgent">Urgent</option>
                            </select>
                        </div>
                        <div class="form-group full-width">
                            <label for="description">Description</label>
                            <textarea id="description" name="description" rows="5"></textarea>
                        </div>
                    </div>
                    <button type="submit">Create Quest</button>
                </form>
            `;
			}

			function createEncounterForm() {
				if (!currentCampaign) {
					document.getElementById('formContainer').innerHTML = '<p>Please select a campaign first.</p>';
					return;
				}

				const sessionOptions = allData.sessions
					.filter((s) => s.campaign_id === currentCampaign)
					.map((s) => `<option value="${s.id}">Session ${s.session_number}: ${s.title}</option>`)
					.join('');

				const locationOptions = allData.locations
					.filter((l) => l.campaign_id === currentCampaign)
					.map((l) => `<option value="${l.id}">${l.name}</option>`)
					.join('');

				const container = document.getElementById('formContainer');
				container.innerHTML = `
                <h2>Add New Encounter</h2>
                <form onsubmit="handleSubmit(event, 'encounters')" id="encounterForm">
                    <input type="hidden" name="campaign_id" value="${currentCampaign}">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="name">Encounter Name *</label>
                            <input type="text" id="name" name="name" required>
                        </div>
                        <div class="form-group">
                            <label for="session_id">Session</label>
                            <select id="session_id" name="session_id">
                                <option value="">None</option>
                                ${sessionOptions}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="location_id">Location</label>
                            <select id="location_id" name="location_id">
                                <option value="">None</option>
                                ${locationOptions}
                            </select>
                        </div>
                        <div class="form-group full-width">
                            <label for="description">Environment Description</label>
                            <textarea id="description" name="description" rows="3" placeholder="Describe the combat environment"></textarea>
                        </div>
                        <div class="form-group full-width">
                            <label for="environment">Environment Details (JSON)</label>
                            <textarea id="environment" name="environment" class="json-editor" rows="3" placeholder='{"terrain": "forest", "weather": "rainy", "time": "night", "lighting": "dim"}'></textarea>
                        </div>
                        <div class="form-group full-width">
                            <label for="notes">Notes</label>
                            <textarea id="notes" name="notes" rows="2"></textarea>
                        </div>
                    </div>
                    <button type="submit">Create Encounter</button>
                    <p style="margin-top: 20px; color: #888; font-size: 0.9em;">
                        üí° After creating the encounter, use the <strong>Initiative</strong> tab to set up combatants, 
                        then use <strong>Combat Log</strong> to track the action-by-action combat.
                    </p>
                </form>
            `;
			}

			function createInitiativeForm() {
				if (!currentCampaign) {
					document.getElementById('formContainer').innerHTML = '<p>Please select a campaign first.</p>';
					return;
				}

				const encounterOptions = allData.encounters
					.filter((e) => e.campaign_id === currentCampaign)
					.map((e) => `<option value="${e.id}">${e.name}</option>`)
					.join('');

				const container = document.getElementById('formContainer');
				container.innerHTML = `
                <h2>Add Initiative Order</h2>
                <p style="margin-bottom: 20px; color: #888;">Set up the turn order for an encounter. Add all combatants with their initiative rolls.</p>
                
                <form onsubmit="handleSubmit(event, 'encounter_initiative')" id="initiativeForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="encounter_id">Encounter *</label>
                            <select id="encounter_id" name="encounter_id" required onchange="updateInitiativeOrder()">
                                <option value="">Select encounter...</option>
                                ${encounterOptions}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="combatant_name">Combatant Name *</label>
                            <input type="text" id="combatant_name" name="combatant_name" required placeholder="e.g., Gandalf, Goblin #1">
                        </div>
                        <div class="form-group">
                            <label for="combatant_type">Type *</label>
                            <select id="combatant_type" name="combatant_type" required>
                                <option value="player">Player</option>
                                <option value="npc">NPC</option>
                                <option value="enemy">Enemy</option>
                                <option value="ally">Ally</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="initiative_roll">Initiative Roll *</label>
                            <input type="number" id="initiative_roll" name="initiative_roll" required>
                        </div>
                        <div class="form-group">
                            <label for="order_index">Turn Order Position *</label>
                            <input type="number" id="order_index" name="order_index" required min="1">
                            <span class="help-text">1 = goes first</span>
                        </div>
                        <div class="form-group">
                            <label for="armor_class">Armor Class</label>
                            <input type="number" id="armor_class" name="armor_class">
                        </div>
                        <div class="form-group">
                            <label for="max_hp">Max HP</label>
                            <input type="number" id="max_hp" name="max_hp">
                        </div>
                        <div class="form-group">
                            <label for="current_hp">Current HP</label>
                            <input type="number" id="current_hp" name="current_hp">
                        </div>
                        <div class="form-group full-width">
                            <label for="conditions">Conditions (JSON Array)</label>
                            <textarea id="conditions" name="conditions" class="json-editor" placeholder='["poisoned", "grappled"]'></textarea>
                        </div>
                        <div class="form-group full-width">
                            <label for="notes">Notes</label>
                            <textarea id="notes" name="notes" rows="2"></textarea>
                        </div>
                    </div>
                    <button type="submit">Add Combatant</button>
                </form>

                <div id="currentInitiative" style="margin-top: 30px;"></div>
            `;

				displayCurrentInitiative();
			}

			function updateInitiativeOrder() {
				displayCurrentInitiative();
			}

			function displayCurrentInitiative() {
				const encounterId = document.getElementById('encounter_id')?.value;
				const container = document.getElementById('currentInitiative');

				if (!encounterId || !container) return;

				const initiativeList = allData.initiative
					.filter((i) => i.encounter_id === encounterId)
					.sort((a, b) => a.order_index - b.order_index);

				if (initiativeList.length === 0) {
					container.innerHTML = '<p style="color: #888;">No combatants added yet.</p>';
					return;
				}

				const encounter = allData.encounters.find((e) => e.id === encounterId);

				container.innerHTML = `
                <h3>Current Initiative Order: ${encounter?.name || 'Encounter'}</h3>
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; margin-top: 10px;">
                    ${initiativeList
											.map(
												(combatant, idx) => `
                        <div style="display: flex; justify-content: space-between; padding: 8px; ${
													idx % 2 === 0 ? 'background: rgba(255,255,255,0.05)' : ''
												}">
                            <span><strong>${combatant.order_index}.</strong> ${combatant.combatant_name} (${
													combatant.combatant_type
												})</span>
                            <span>Init: ${combatant.initiative_roll} | AC: ${combatant.armor_class || '?'} | HP: ${
													combatant.current_hp || '?'
												}/${combatant.max_hp || '?'}</span>
                        </div>
                    `
											)
											.join('')}
                </div>
            `;
			}

			function createCombatLogForm() {
				if (!currentCampaign) {
					document.getElementById('formContainer').innerHTML = '<p>Please select a campaign first.</p>';
					return;
				}

				const encounterOptions = allData.encounters
					.filter((e) => e.campaign_id === currentCampaign)
					.map((e) => `<option value="${e.id}">${e.name}</option>`)
					.join('');

				const container = document.getElementById('formContainer');
				container.innerHTML = `
                <h2>Combat Action Log</h2>
                <p style="margin-bottom: 20px; color: #888;">Log each action in combat. Add rounds first, then add actions within each round.</p>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                    <div>
                        <h3>Add Round</h3>
                        <form onsubmit="handleSubmit(event, 'encounter_rounds')" id="roundForm">
                            <div class="form-group">
                                <label for="round_encounter_id">Encounter *</label>
                                <select id="round_encounter_id" name="encounter_id" required onchange="updateCombatLog()">
                                    <option value="">Select encounter...</option>
                                    ${encounterOptions}
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="round_number">Round Number *</label>
                                <input type="number" id="round_number" name="round_number" required min="1">
                            </div>
                            <div class="form-group">
                                <label for="round_notes">Round Notes</label>
                                <textarea id="round_notes" name="round_notes" rows="2"></textarea>
                            </div>
                            <button type="submit">Add Round</button>
                        </form>
                    </div>

                    <div>
                        <h3>Add Consequence</h3>
                        <form onsubmit="handleSubmit(event, 'encounter_consequences')" id="consequenceForm">
                            <div class="form-group">
                                <label for="cons_encounter_id">Encounter *</label>
                                <select id="cons_encounter_id" name="encounter_id" required>
                                    <option value="">Select encounter...</option>
                                    ${encounterOptions}
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="consequence_type">Type *</label>
                                <select id="consequence_type" name="consequence_type" required>
                                    <option value="enemy_defeated">Enemy Defeated</option>
                                    <option value="item_obtained">Item Obtained</option>
                                    <option value="complication">Complication</option>
                                    <option value="injury">Injury</option>
                                    <option value="consequence">Consequence</option>
                                    <option value="discovery">Discovery</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="cons_description">Description *</label>
                                <input type="text" id="cons_description" name="description" required>
                            </div>
                            <button type="submit">Add Consequence</button>
                        </form>
                    </div>
                </div>

                <h3>Add Combat Action</h3>
                <form onsubmit="handleSubmit(event, 'encounter_actions')" id="actionForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="action_encounter_id">Encounter *</label>
                            <select id="action_encounter_id" name="encounter_id" required onchange="updateActionRounds()">
                                <option value="">Select encounter...</option>
                                ${encounterOptions}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="action_round_number">Round *</label>
                            <select id="action_round_number" name="round_number" required>
                                <option value="">Select round...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="action_order">Action Order *</label>
                            <input type="number" id="action_order" name="action_order" required min="1">
                            <span class="help-text">Order within the round</span>
                        </div>
                        <div class="form-group">
                            <label for="actor_name">Actor *</label>
                            <input type="text" id="actor_name" name="actor_name" required placeholder="Who is acting?">
                        </div>
                        <div class="form-group">
                            <label for="action_type">Action Type</label>
                            <input type="text" id="action_type" name="action_type" placeholder="e.g., Attack, Spell, Move, Bonus Action">
                        </div>
                        <div class="form-group">
                            <label for="target_name">Target</label>
                            <input type="text" id="target_name" name="target_name" placeholder="Who is targeted?">
                        </div>
                        <div class="form-group">
                            <label for="attack_roll">Attack Roll</label>
                            <input type="number" id="attack_roll" name="attack_roll">
                        </div>
                        <div class="form-group">
                            <label for="damage_roll">Damage Roll</label>
                            <input type="text" id="damage_roll" name="damage_roll" placeholder="e.g., 2d6+3">
                        </div>
                        <div class="form-group">
                            <label for="damage_dealt">Damage Dealt</label>
                            <input type="number" id="damage_dealt" name="damage_dealt">
                        </div>
                        <div class="form-group">
                            <label for="result">Result</label>
                            <input type="text" id="result" name="result" placeholder="e.g., Hit, Miss, Critical">
                        </div>
                        <div class="form-group full-width">
                            <label for="action_description">Action Description *</label>
                            <textarea id="action_description" name="action_description" required rows="2" placeholder="Describe what happens"></textarea>
                        </div>
                        <div class="form-group full-width">
                            <label for="action_notes">Notes</label>
                            <textarea id="action_notes" name="notes" rows="2"></textarea>
                        </div>
                    </div>
                    <button type="submit">Log Action</button>
                </form>

                <div id="combatLogDisplay" style="margin-top: 30px;"></div>
            `;

				updateCombatLog();
			}

			function updateActionRounds() {
				const encounterId = document.getElementById('action_encounter_id')?.value;
				const roundSelect = document.getElementById('action_round_number');

				if (!encounterId || !roundSelect) return;

				const rounds = allData.rounds
					.filter((r) => r.encounter_id === encounterId)
					.sort((a, b) => a.round_number - b.round_number);

				roundSelect.innerHTML =
					'<option value="">Select round...</option>' +
					rounds.map((r) => `<option value="${r.round_number}">Round ${r.round_number}</option>`).join('');
			}

			function updateCombatLog() {
				const encounterId =
					document.getElementById('round_encounter_id')?.value || document.getElementById('action_encounter_id')?.value;
				const container = document.getElementById('combatLogDisplay');

				if (!encounterId || !container) return;

				const rounds = allData.rounds
					.filter((r) => r.encounter_id === encounterId)
					.sort((a, b) => a.round_number - b.round_number);

				const actions = allData.actions.filter((a) => a.encounter_id === encounterId);

				const consequences = allData.consequences.filter((c) => c.encounter_id === encounterId);

				const encounter = allData.encounters.find((e) => e.id === encounterId);

				if (rounds.length === 0 && actions.length === 0 && consequences.length === 0) {
					container.innerHTML = '<p style="color: #888;">No combat log yet.</p>';
					return;
				}

				let html = `<h3>Combat Log: ${encounter?.name || 'Encounter'}</h3>`;

				html += '<div style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 8px; margin-top: 10px;">';

				rounds.forEach((round) => {
					const roundActions = actions
						.filter((a) => a.round_number === round.round_number)
						.sort((a, b) => a.action_order - b.action_order);

					html += `
                    <div style="margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                        <h4 style="color: #667eea; margin-bottom: 10px;">‚öîÔ∏è Round ${round.round_number}</h4>
                        ${
													round.round_notes
														? `<p style="color: #888; font-style: italic; margin-bottom: 10px;">${round.round_notes}</p>`
														: ''
												}
                        ${roundActions
													.map(
														(action, idx) => `
                            <div style="margin: 8px 0; padding: 10px; background: rgba(255,255,255,0.03); border-radius: 4px;">
                                <strong>${action.actor_name}</strong> 
                                ${action.target_name ? `‚Üí <strong>${action.target_name}</strong>` : ''}
                                ${action.action_type ? `<span style="color: #888;">(${action.action_type})</span>` : ''}
                                <br>
                                <span style="color: #b0b0b0;">${action.action_description}</span>
                                ${
																	action.attack_roll
																		? `<br><span style="color: #888;">Attack: ${action.attack_roll}</span>`
																		: ''
																}
                                ${
																	action.damage_dealt
																		? `<span style="color: #f44336;"> | Damage: ${action.damage_dealt}</span>`
																		: ''
																}
                                ${action.result ? `<span style="color: #4CAF50;"> | ${action.result}</span>` : ''}
                            </div>
                        `
													)
													.join('')}
                    </div>
                `;
				});

				if (consequences.length > 0) {
					html += `
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid rgba(255,255,255,0.2);">
                        <h4 style="color: #f39c12;">üìä Outcome & Consequences</h4>
                        ${consequences
													.map(
														(c) => `
                            <div style="margin: 8px 0; padding: 10px; background: rgba(243, 156, 18, 0.1); border-radius: 4px;">
                                <strong style="text-transform: capitalize;">${c.consequence_type.replace(
																	'_',
																	' '
																)}</strong>: ${c.description}
                            </div>
                        `
													)
													.join('')}
                    </div>
                `;
				}

				html += '</div>';
				container.innerHTML = html;
			}

			function createEventForm() {
				if (!currentCampaign) {
					document.getElementById('formContainer').innerHTML = '<p>Please select a campaign first.</p>';
					return;
				}

				const sessionOptions = allData.sessions
					.filter((s) => s.campaign_id === currentCampaign)
					.map((s) => `<option value="${s.id}">Session ${s.session_number}: ${s.title}</option>`)
					.join('');

				const npcOptions = allData.npcs
					.filter((n) => n.campaign_id === currentCampaign)
					.map((n) => `<option value="${n.id}">${n.name}</option>`)
					.join('');

				const locationOptions = allData.locations
					.filter((l) => l.campaign_id === currentCampaign)
					.map((l) => `<option value="${l.id}">${l.name}</option>`)
					.join('');

				const questOptions = allData.quests
					.filter((q) => q.campaign_id === currentCampaign)
					.map((q) => `<option value="${q.id}">${q.title}</option>`)
					.join('');

				const encounterOptions = allData.encounters
					.filter((e) => e.campaign_id === currentCampaign)
					.map((e) => `<option value="${e.id}">${e.name}</option>`)
					.join('');

				const factionOptions = allData.factions
					.filter((f) => f.campaign_id === currentCampaign)
					.map((f) => `<option value="${f.id}">${f.name}</option>`)
					.join('');

				const characterOptions = allData.characters
					.filter((c) => c.campaign_id === currentCampaign)
					.map((c) => `<option value="${c.id}">${c.name}</option>`)
					.join('');

				const container = document.getElementById('formContainer');
				container.innerHTML = `
                <h2>Add Session Event</h2>
                <p style="margin-bottom: 20px; color: #888;">This is the magic! Add an event and watch it propagate automatically.</p>
                <form onsubmit="handleSubmit(event, 'session_events')" id="eventForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="session_id">Session *</label>
                            <select id="session_id" name="session_id" required>
                                <option value="">Select session...</option>
                                ${sessionOptions}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="event_order">Event Order *</label>
                            <input type="number" id="event_order" name="event_order" required min="1">
                            <span class="help-text">Order within the session</span>
                        </div>
                        <div class="form-group">
                            <label for="event_type">Event Type *</label>
                            <select id="event_type" name="event_type" required onchange="handleEventTypeChange()">
                                <option value="">Select type...</option>
                                <option value="npc_introduced">NPC Introduced</option>
                                <option value="npc_encountered">NPC Encountered</option>
                                <option value="npc_died">NPC Died</option>
                                <option value="npc_relocated">NPC Relocated</option>
                                <option value="npc_joined_faction">NPC Joined Faction</option>
                                <option value="npc_left_faction">NPC Left Faction</option>
                                <option value="npc_relationship_changed">NPC Relationship Changed</option>
                                <option value="location_discovered">Location Discovered</option>
                                <option value="location_visited">Location Visited</option>
                                <option value="location_changed">Location Changed</option>
                                <option value="quest_started">Quest Started</option>
                                <option value="quest_updated">Quest Updated</option>
                                <option value="quest_completed">Quest Completed</option>
                                <option value="quest_failed">Quest Failed</option>
                                <option value="objective_completed">Objective Completed</option>
                                <option value="encounter_fought">Encounter Fought</option>
                                <option value="item_acquired">Item Acquired</option>
                                <option value="item_lost">Item Lost</option>
                                <option value="faction_discovered">Faction Discovered</option>
                                <option value="character_leveled">Character Leveled</option>
                                <option value="story_event">Story Event</option>
                                <option value="custom">Custom</option>
                            </select>
                        </div>
                        <div class="form-group full-width">
                            <label for="title">Event Title *</label>
                            <input type="text" id="title" name="title" required placeholder="e.g., Met Gundren Rockseeker">
                        </div>
                        <div class="form-group full-width">
                            <label for="description">Description</label>
                            <textarea id="description" name="description" rows="3"></textarea>
                        </div>

                        <div class="form-group" id="npc_field" style="display: none;">
                            <label for="npc_id">NPC</label>
                            <select id="npc_id" name="npc_id">
                                <option value="">None</option>
                                ${npcOptions}
                            </select>
                        </div>

                        <div class="form-group" id="location_field" style="display: none;">
                            <label for="location_id">Location</label>
                            <select id="location_id" name="location_id">
                                <option value="">None</option>
                                ${locationOptions}
                            </select>
                        </div>

                        <div class="form-group" id="quest_field" style="display: none;">
                            <label for="quest_id">Quest</label>
                            <select id="quest_id" name="quest_id">
                                <option value="">None</option>
                                ${questOptions}
                            </select>
                        </div>

                        <div class="form-group" id="encounter_field" style="display: none;">
                            <label for="encounter_id">Encounter</label>
                            <select id="encounter_id" name="encounter_id">
                                <option value="">None</option>
                                ${encounterOptions}
                            </select>
                        </div>

                        <div class="form-group" id="faction_field" style="display: none;">
                            <label for="faction_id">Faction</label>
                            <select id="faction_id" name="faction_id">
                                <option value="">None</option>
                                ${factionOptions}
                            </select>
                        </div>

                        <div class="form-group" id="character_field" style="display: none;">
                            <label for="character_id">Character</label>
                            <select id="character_id" name="character_id">
                                <option value="">None</option>
                                ${characterOptions}
                            </select>
                        </div>

                        <div class="form-group full-width">
                            <label for="event_data">Event Data (JSON)</label>
                            <textarea id="event_data" name="event_data" class="json-editor" rows="3" placeholder='{"key": "value"}'></textarea>
                            <span class="help-text">Optional additional data</span>
                        </div>
                    </div>
                    <button type="submit">Create Event (Auto-Propagates!)</button>
                </form>
            `;
			}

			function handleEventTypeChange() {
				const eventType = document.getElementById('event_type').value;

				// Hide all conditional fields
				document.getElementById('npc_field').style.display = 'none';
				document.getElementById('location_field').style.display = 'none';
				document.getElementById('quest_field').style.display = 'none';
				document.getElementById('encounter_field').style.display = 'none';
				document.getElementById('faction_field').style.display = 'none';
				document.getElementById('character_field').style.display = 'none';

				// Show relevant fields based on event type
				if (eventType.startsWith('npc_')) {
					document.getElementById('npc_field').style.display = 'block';
					if (eventType === 'npc_relocated') {
						document.getElementById('location_field').style.display = 'block';
					}
					if (eventType === 'npc_joined_faction' || eventType === 'npc_left_faction') {
						document.getElementById('faction_field').style.display = 'block';
					}
				} else if (eventType.startsWith('location_')) {
					document.getElementById('location_field').style.display = 'block';
				} else if (eventType.startsWith('quest_')) {
					document.getElementById('quest_field').style.display = 'block';
				} else if (eventType === 'encounter_fought') {
					document.getElementById('encounter_field').style.display = 'block';
				} else if (eventType === 'faction_discovered') {
					document.getElementById('faction_field').style.display = 'block';
				} else if (eventType === 'character_leveled') {
					document.getElementById('character_field').style.display = 'block';
				}
			}

			async function handleSubmit(event, tableName) {
				event.preventDefault();
				const form = event.target;
				const formData = new FormData(form);
				const data = {};

				// Convert form data to object
				for (let [key, value] of formData.entries()) {
					if (value === '') {
						data[key] = null;
					} else if (
						key.includes('jsonb') ||
						key === 'metadata' ||
						key === 'styling' ||
						key === 'stats' ||
						key === 'environment' ||
						key === 'outcome' ||
						key === 'event_data'
					) {
						try {
							data[key] = value ? JSON.parse(value) : null;
						} catch (e) {
							showMessage(`Invalid JSON in ${key}: ${e.message}`, 'error');
							return;
						}
					} else if (key === 'is_active') {
						data[key] = value === 'true';
					} else if (key === 'level' || key === 'session_number' || key === 'event_order') {
						data[key] = value ? parseInt(value) : null;
					} else if (key === 'campaign_id' && !value.includes('-')) {
						// This is an integer campaign_id, not a UUID
						data[key] = parseInt(value);
					} else {
						data[key] = value;
					}
				}

				// Remove null/empty values for optional foreign keys
				Object.keys(data).forEach((key) => {
					if (data[key] === null && (key.includes('_id') || key === 'parent_location_id')) {
						delete data[key];
					}
					// Remove empty string UUID fields
					if (data[key] === '' && key.includes('_id')) {
						delete data[key];
					}
				});

				try {
					const { data: result, error } = await supabase.from(tableName).insert([data]).select();

					if (error) throw error;

					showMessage(`‚úÖ Successfully created ${tableName.slice(0, -1)}!`, 'success!');
					form.reset();

					// Reload data to update selectors
					await loadAllData();

					// If we just created a campaign, select it
					if (tableName === 'campaigns' && result && result[0]) {
						document.getElementById('campaignSelect').value = result[0].id;
						currentCampaign = result[0].id;
					}
				} catch (error) {
					showMessage(`‚ùå Error: ${error.message}`, 'error');
					console.error('Submission error:', error);
				}
			}

			// Initialize with campaigns tab
			window.onload = () => {
				switchTab('campaigns');
			};
		</script>
	</body>
</html>
