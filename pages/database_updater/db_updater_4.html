<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>D&D Campaign Manager</title>
		<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
		<style>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}

			body {
				font-family: 'Crimson Text', 'Garamond', 'Book Antiqua', Georgia, serif;
				background: #e8dcc0;
				background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><filter id="noise"><feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="4" /></filter><rect width="100" height="100" filter="url(%23noise)" opacity="0.05"/></svg>');
				color: #2b1810;
				min-height: 100vh;
				padding: 20px;
			}

			.container {
				max-width: 1400px;
				margin: 0 auto;
			}

			header {
				background: linear-gradient(to bottom, #f4ead5 0%, #e8dcc0 100%);
				padding: 30px 40px;
				border-radius: 4px;
				margin-bottom: 30px;
				border: 3px solid #8b6f47;
				box-shadow: inset 0 0 30px rgba(139, 111, 71, 0.1), 0 4px 8px rgba(0, 0, 0, 0.2);
				position: relative;
			}

			header::before,
			header::after {
				content: '‚óà';
				position: absolute;
				top: 50%;
				transform: translateY(-50%);
				font-size: 2em;
				color: #8b6f47;
			}

			header::before {
				left: 10px;
			}

			header::after {
				right: 10px;
			}

			h1 {
				color: #2b1810;
				font-size: 2.5em;
				margin-bottom: 10px;
				text-align: center;
				font-weight: 700;
				letter-spacing: 3px;
				text-transform: uppercase;
				font-family: 'Cinzel', serif;
				text-shadow: 2px 2px 0px rgba(139, 111, 71, 0.2);
			}

			header > p {
				text-align: center;
				font-style: italic;
				color: #5a4a3a;
				font-size: 1.1em;
			}

			.config-section {
				background: rgba(139, 111, 71, 0.1);
				border: 2px solid #8b6f47;
				padding: 20px;
				border-radius: 4px;
				margin-top: 20px;
			}

			.config-section h3 {
				font-family: 'Cinzel', serif;
				color: #2b1810;
				margin-bottom: 15px;
				font-size: 1.3em;
			}

			.config-section input {
				width: 100%;
				padding: 10px;
				margin: 8px 0;
				background: #f9f6f0;
				border: 2px solid #8b6f47;
				border-radius: 2px;
				color: #2b1810;
				font-family: inherit;
			}

			.config-section button {
				background: linear-gradient(to bottom, #8b6f47 0%, #6b4f27 100%);
				color: #f4ead5;
				border: 2px solid #5a3f1f;
				padding: 12px 24px;
				border-radius: 2px;
				cursor: pointer;
				margin-top: 10px;
				font-family: 'Cinzel', serif;
				text-transform: uppercase;
				letter-spacing: 1px;
				font-weight: 600;
				box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
			}

			.config-section button:hover {
				background: linear-gradient(to bottom, #9b7f57 0%, #7b5f37 100%);
			}

			.tabs {
				display: flex;
				gap: 10px;
				margin-bottom: 20px;
				flex-wrap: wrap;
			}

			.tab {
				padding: 12px 24px;
				background: linear-gradient(to bottom, #f4ead5 0%, #e8dcc0 100%);
				border: 2px solid #8b6f47;
				border-radius: 2px;
				cursor: pointer;
				transition: all 0.3s;
				font-family: 'Cinzel', serif;
				font-weight: 600;
				color: #2b1810;
				text-transform: uppercase;
				font-size: 0.85em;
				letter-spacing: 1px;
				box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
			}

			.tab:hover {
				background: linear-gradient(to bottom, #fff5e6 0%, #f4ead5 100%);
				transform: translateY(-2px);
				box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
			}

			.tab.active {
				background: linear-gradient(to bottom, #8b6f47 0%, #6b4f27 100%);
				color: #f4ead5;
				border-color: #5a3f1f;
				box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
			}

			.content-area {
				background: linear-gradient(to bottom, #f9f6f0 0%, #f4ead5 100%);
				padding: 40px;
				border-radius: 4px;
				border: 3px solid #8b6f47;
				box-shadow: inset 0 0 50px rgba(139, 111, 71, 0.05), 0 4px 12px rgba(0, 0, 0, 0.2);
				position: relative;
			}

			.content-area::before {
				content: '';
				position: absolute;
				top: 10px;
				left: 10px;
				right: 10px;
				bottom: 10px;
				border: 1px solid rgba(139, 111, 71, 0.3);
				pointer-events: none;
			}

			h2,
			h3 {
				font-family: 'Cinzel', serif;
				color: #2b1810;
				margin-bottom: 20px;
				font-weight: 700;
				border-bottom: 2px solid #8b6f47;
				padding-bottom: 10px;
			}

			h2 {
				font-size: 1.8em;
			}

			h3 {
				font-size: 1.4em;
				margin-top: 30px;
			}

			.form-grid {
				display: grid;
				grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
				gap: 25px;
				margin-bottom: 25px;
			}

			.form-group {
				display: flex;
				flex-direction: column;
			}

			.full-width {
				grid-column: 1 / -1;
			}

			label {
				margin-bottom: 8px;
				color: #2b1810;
				font-size: 0.95em;
				font-weight: 600;
				text-transform: uppercase;
				letter-spacing: 0.5px;
				font-family: 'Cinzel', serif;
			}

			input,
			select,
			textarea {
				padding: 12px;
				background: #fff;
				border: 2px solid #8b6f47;
				border-radius: 2px;
				color: #2b1810;
				font-size: 1em;
				transition: all 0.3s;
				font-family: 'Crimson Text', Georgia, serif;
			}

			input:focus,
			select:focus,
			textarea:focus {
				outline: none;
				border-color: #5a3f1f;
				box-shadow: 0 0 0 3px rgba(139, 111, 71, 0.2);
				background: #fffef8;
			}

			textarea {
				min-height: 120px;
				resize: vertical;
				font-family: 'Crimson Text', Georgia, serif;
				line-height: 1.6;
			}

			.json-editor {
				font-family: 'Courier New', monospace;
				background: #f5f5f0;
				font-size: 0.9em;
			}

			button {
				padding: 14px 32px;
				background: linear-gradient(to bottom, #8b6f47 0%, #6b4f27 100%);
				color: #f4ead5;
				border: 2px solid #5a3f1f;
				border-radius: 2px;
				cursor: pointer;
				font-size: 1em;
				font-weight: 600;
				transition: all 0.3s;
				margin-top: 10px;
				font-family: 'Cinzel', serif;
				text-transform: uppercase;
				letter-spacing: 1px;
				box-shadow: 0 3px 6px rgba(0, 0, 0, 0.3);
			}

			button:hover {
				transform: translateY(-2px);
				box-shadow: 0 5px 10px rgba(0, 0, 0, 0.4);
				background: linear-gradient(to bottom, #9b7f57 0%, #7b5f37 100%);
			}

			button:active {
				transform: translateY(0);
			}

			.message {
				padding: 15px 20px;
				border-radius: 2px;
				margin-bottom: 20px;
				display: none;
				border: 2px solid;
				font-weight: 600;
			}

			.message.success {
				background: rgba(106, 153, 78, 0.1);
				border-color: #6a994e;
				color: #3d5a27;
			}

			.message.error {
				background: rgba(168, 50, 50, 0.1);
				border-color: #a83232;
				color: #6b1e1e;
			}

			.hidden {
				display: none;
			}

			.help-text {
				font-size: 0.85em;
				color: #6b5642;
				margin-top: 4px;
				font-style: italic;
			}

			.campaign-selector {
				margin-bottom: 20px;
				padding: 20px;
				background: linear-gradient(to bottom, #f4ead5 0%, #e8dcc0 100%);
				border-radius: 4px;
				border: 2px solid #8b6f47;
			}

			.campaign-selector label {
				display: block;
				margin-bottom: 10px;
				font-family: 'Cinzel', serif;
			}

			.campaign-selector select {
				width: 100%;
				max-width: 400px;
			}

			.data-table {
				width: 100%;
				margin-top: 25px;
				border-collapse: separate;
				border-spacing: 0;
				border: 2px solid #8b6f47;
				border-radius: 2px;
				overflow: hidden;
			}

			.data-table th,
			.data-table td {
				padding: 14px;
				text-align: left;
				border-bottom: 1px solid #d4c4a8;
			}

			.data-table th {
				background: linear-gradient(to bottom, #8b6f47 0%, #7b5f37 100%);
				color: #f4ead5;
				font-weight: 700;
				text-transform: uppercase;
				letter-spacing: 1px;
				font-family: 'Cinzel', serif;
				font-size: 0.9em;
			}

			.data-table tbody tr {
				background: #fff;
				transition: background 0.2s;
			}

			.data-table tbody tr:nth-child(even) {
				background: #f9f6f0;
			}

			.data-table tbody tr:hover {
				background: #fff5e6;
			}

			.data-table tbody tr:last-child td {
				border-bottom: none;
			}

			.action-btn {
				padding: 8px 16px;
				margin: 0 4px;
				font-size: 0.85em;
				font-family: 'Cinzel', serif;
			}

			.action-btn.edit {
				background: linear-gradient(to bottom, #6a994e 0%, #5a8940 100%);
				border-color: #4a7030;
			}

			.action-btn.edit:hover {
				background: linear-gradient(to bottom, #7aaa5e 0%, #6a9950 100%);
			}

			.action-btn.delete {
				background: linear-gradient(to bottom, #a83232 0%, #882222 100%);
				border-color: #681818;
			}

			.action-btn.delete:hover {
				background: linear-gradient(to bottom, #b84242 0%, #983232 100%);
			}

			/* Decorative corners */
			.content-area::after {
				content: '‚öî';
				position: absolute;
				bottom: 15px;
				right: 15px;
				font-size: 1.5em;
				color: rgba(139, 111, 71, 0.2);
			}
		</style>
	</head>
	<body>
		<div class="container">
			<header>
				<h1>üé≤ D&D Campaign Manager</h1>
				<p>Easily add campaigns, sessions, NPCs, locations, and more to your database</p>
				<div class="config-section" id="configSection">
					<h3>‚öôÔ∏è Supabase Configuration</h3>
					<input
						type="text"
						id="supabaseUrl"
						placeholder="Supabase URL"
						value="https://yffukfulnggfhlgoyowg.supabase.co" />
					<input
						type="password"
						id="supabaseKey"
						placeholder="Supabase Anon Key"
						value="sb_publishable_AX2-qMjR0Jigxgcc3UET1g_YYBTaBUz" />
					<button onclick="app.connectSupabase()">Connect to Database</button>
				</div>
			</header>

			<div id="mainContent" class="hidden">
				<div class="campaign-selector">
					<label><strong>Select Active Campaign:</strong></label>
					<select id="campaignSelect" onchange="app.setCampaign(this.value)">
						<option value="">-- Select a campaign --</option>
					</select>
				</div>
				<div class="tabs" id="tabs"></div>
				<div class="content-area">
					<div id="message" class="message"></div>
					<div id="formContainer"></div>
				</div>
			</div>
		</div>

		<script>
			const SCHEMA = {
				campaigns: {
					label: 'Campaigns',
					requiresCampaign: false,
					fields: [
						{ name: 'campaign_id', label: 'Campaign ID', type: 'number', required: true },
						{ name: 'name', label: 'Campaign Name', type: 'text', required: true },
						{ name: 'metadata', label: 'Metadata', type: 'json', fullWidth: true },
						{ name: 'styling', label: 'Styling', type: 'json', fullWidth: true },
					],
					displayFields: ['campaign_id', 'name', 'created_at'],
				},
				sessions: {
					label: 'Sessions',
					requiresCampaign: true,
					fields: [
						{ name: 'session_number', label: 'Session Number', type: 'number', required: true },
						{ name: 'title', label: 'Session Title', type: 'text', required: true },
						{ name: 'session_date', label: 'Date', type: 'date', required: true },
						{ name: 'summary', label: 'Summary', type: 'textarea', fullWidth: true },
						{ name: 'narrative', label: 'Narrative', type: 'textarea', fullWidth: true, rows: 10 },
					],
					displayFields: ['session_number', 'title', 'session_date'],
				},
				characters: {
					label: 'Characters',
					requiresCampaign: true,
					fields: [
						{ name: 'name', label: 'Name', type: 'text', required: true },
						{ name: 'race', label: 'Race', type: 'text' },
						{ name: 'class', label: 'Class', type: 'text' },
						{ name: 'level', label: 'Level', type: 'number', min: 1, max: 20 },
						{ name: 'icon', label: 'Icon URL', type: 'text' },
						{ name: 'image_bg', label: 'Background Image URL', type: 'text' },
						{ name: 'short_description', label: 'Short Description', type: 'textarea', fullWidth: true, rows: 2 },
						{ name: 'background', label: 'Background', type: 'textarea', fullWidth: true },
						{ name: 'stats', label: 'Stats', type: 'json', fullWidth: true },
						{
							name: 'is_active',
							label: 'Active Character',
							type: 'select',
							options: [
								{ value: 'true', label: 'Yes' },
								{ value: 'false', label: 'No' },
							],
						},
					],
					displayFields: ['name', 'race', 'class', 'level'],
				},
				npcs: {
					label: 'NPCs',
					requiresCampaign: true,
					fields: [
						{ name: 'name', label: 'Name', type: 'text', required: true },
						{ name: 'race', label: 'Race', type: 'text' },
						{ name: 'class', label: 'Class', type: 'text' },
						{ name: 'gender', label: 'Gender', type: 'text' },
						{
							name: 'affinity',
							label: 'Affinity',
							type: 'select',
							options: [
								{ value: 'unknown', label: 'Unknown' },
								{ value: 'ally', label: 'Ally' },
								{ value: 'neutral', label: 'Neutral' },
								{ value: 'enemy', label: 'Enemy' },
							],
						},
						{
							name: 'status',
							label: 'Status',
							type: 'select',
							options: [
								{ value: 'alive', label: 'Alive' },
								{ value: 'dead', label: 'Dead' },
								{ value: 'unknown', label: 'Unknown' },
								{ value: 'missing', label: 'Missing' },
							],
						},
						{ name: 'role', label: 'Role/Occupation', type: 'text' },
						{ name: 'portrait', label: 'Portrait URL', type: 'text' },
						{ name: 'description', label: 'Description', type: 'textarea', fullWidth: true },
						{ name: 'personality', label: 'Personality', type: 'textarea', fullWidth: true },
						{ name: 'background', label: 'Background', type: 'textarea', fullWidth: true },
					],
					displayFields: ['name', 'race', 'role', 'affinity', 'status'],
				},
				locations: {
					label: 'Locations',
					requiresCampaign: true,
					fields: [
						{ name: 'name', label: 'Name', type: 'text', required: true },
						{
							name: 'type',
							label: 'Type',
							type: 'select',
							options: [
								{ value: '', label: 'Select...' },
								{ value: 'city', label: 'City' },
								{ value: 'town', label: 'Town' },
								{ value: 'village', label: 'Village' },
								{ value: 'dungeon', label: 'Dungeon' },
								{ value: 'wilderness', label: 'Wilderness' },
								{ value: 'plane', label: 'Plane' },
								{ value: 'region', label: 'Region' },
								{ value: 'landmark', label: 'Landmark' },
								{ value: 'building', label: 'Building' },
								{ value: 'room', label: 'Room' },
							],
						},
						{ name: 'parent_location_id', label: 'Parent Location', type: 'reference', table: 'locations' },
						{ name: 'region', label: 'Region', type: 'text' },
						{ name: 'population', label: 'Population', type: 'text' },
						{ name: 'ruler', label: 'Ruler', type: 'text' },
						{ name: 'government_type', label: 'Government Type', type: 'text' },
						{ name: 'size', label: 'Size', type: 'text' },
						{ name: 'races', label: 'Common Races', type: 'text' },
						{ name: 'natives', label: 'Natives', type: 'text' },
						{ name: 'exports', label: 'Exports', type: 'text' },
						{ name: 'imports', label: 'Imports', type: 'text' },
						{ name: 'description', label: 'Description', type: 'textarea', fullWidth: true },
						{ name: 'history', label: 'History', type: 'textarea', fullWidth: true },
					],
					displayFields: ['name', 'type', 'region', 'population'],
				},
				factions: {
					label: 'Factions',
					requiresCampaign: true,
					fields: [
						{ name: 'name', label: 'Faction Name', type: 'text', required: true },
						{ name: 'type', label: 'Type', type: 'text' },
						{ name: 'leader_npc_id', label: 'Leader', type: 'reference', table: 'npcs' },
						{ name: 'description', label: 'Description', type: 'textarea', fullWidth: true },
					],
					displayFields: ['name', 'type'],
				},
				quests: {
					label: 'Quests',
					requiresCampaign: true,
					fields: [
						{ name: 'title', label: 'Quest Title', type: 'text', required: true },
						{
							name: 'status',
							label: 'Status',
							type: 'select',
							options: [
								{ value: 'active', label: 'Active' },
								{ value: 'completed', label: 'Completed' },
								{ value: 'failed', label: 'Failed' },
								{ value: 'on-hold', label: 'On Hold' },
								{ value: 'abandoned', label: 'Abandoned' },
							],
						},
						{
							name: 'priority',
							label: 'Priority',
							type: 'select',
							options: [
								{ value: 'low', label: 'Low' },
								{ value: 'medium', label: 'Medium' },
								{ value: 'high', label: 'High' },
								{ value: 'urgent', label: 'Urgent' },
							],
						},
						{ name: 'description', label: 'Description', type: 'textarea', fullWidth: true },
					],
					displayFields: ['title', 'status', 'priority'],
				},
				encounters: {
					label: 'Encounters',
					requiresCampaign: true,
					fields: [
						{ name: 'name', label: 'Encounter Name', type: 'text', required: true },
						{ name: 'session_id', label: 'Session', type: 'reference', table: 'sessions' },
						{ name: 'location_id', label: 'Location', type: 'reference', table: 'locations' },
						{ name: 'description', label: 'Environment Description', type: 'textarea', fullWidth: true },
						{ name: 'environment', label: 'Environment Details', type: 'json', fullWidth: true },
						{ name: 'notes', label: 'Notes', type: 'textarea', fullWidth: true },
					],
					displayFields: ['name', 'session_id', 'location_id'],
				},
				encounter_initiative: {
					label: 'Initiative',
					requiresCampaign: true,
					fields: [
						{ name: 'encounter_id', label: 'Encounter', type: 'reference', table: 'encounters', required: true },
						{ name: 'combatant_name', label: 'Combatant Name', type: 'text', required: true },
						{
							name: 'combatant_type',
							label: 'Type',
							type: 'select',
							required: true,
							options: [
								{ value: 'player', label: 'Player' },
								{ value: 'npc', label: 'NPC' },
								{ value: 'enemy', label: 'Enemy' },
								{ value: 'ally', label: 'Ally' },
							],
						},
						{ name: 'initiative_roll', label: 'Initiative Roll', type: 'number', required: true },
						{ name: 'order_index', label: 'Turn Order Position', type: 'number', required: true, min: 1 },
						{ name: 'armor_class', label: 'Armor Class', type: 'number' },
						{ name: 'max_hp', label: 'Max HP', type: 'number' },
						{ name: 'current_hp', label: 'Current HP', type: 'number' },
						{ name: 'conditions', label: 'Conditions', type: 'json', fullWidth: true },
						{ name: 'notes', label: 'Notes', type: 'textarea', fullWidth: true },
					],
					displayFields: ['combatant_name', 'combatant_type', 'initiative_roll', 'order_index'],
				},
				encounter_rounds: {
					label: 'Combat Rounds',
					requiresCampaign: true,
					fields: [
						{ name: 'encounter_id', label: 'Encounter', type: 'reference', table: 'encounters', required: true },
						{ name: 'round_number', label: 'Round Number', type: 'number', required: true, min: 1 },
						{ name: 'round_notes', label: 'Round Notes', type: 'textarea', fullWidth: true },
					],
					displayFields: ['encounter_id', 'round_number'],
				},
				encounter_actions: {
					label: 'Combat Actions',
					requiresCampaign: true,
					fields: [
						{ name: 'encounter_id', label: 'Encounter', type: 'reference', table: 'encounters', required: true },
						{ name: 'round_number', label: 'Round', type: 'number', required: true },
						{ name: 'action_order', label: 'Action Order', type: 'number', required: true, min: 1 },
						{ name: 'actor_name', label: 'Actor', type: 'text', required: true },
						{ name: 'action_type', label: 'Action Type', type: 'text' },
						{ name: 'target_name', label: 'Target', type: 'text' },
						{ name: 'attack_roll', label: 'Attack Roll', type: 'number' },
						{ name: 'damage_roll', label: 'Damage Roll', type: 'text' },
						{ name: 'damage_dealt', label: 'Damage Dealt', type: 'number' },
						{ name: 'result', label: 'Result', type: 'text' },
						{
							name: 'action_description',
							label: 'Action Description',
							type: 'textarea',
							fullWidth: true,
							required: true,
						},
						{ name: 'notes', label: 'Notes', type: 'textarea', fullWidth: true },
					],
					displayFields: ['actor_name', 'action_type', 'round_number', 'action_order'],
				},
				encounter_consequences: {
					label: 'Combat Consequences',
					requiresCampaign: true,
					fields: [
						{ name: 'encounter_id', label: 'Encounter', type: 'reference', table: 'encounters', required: true },
						{
							name: 'consequence_type',
							label: 'Type',
							type: 'select',
							required: true,
							options: [
								{ value: 'enemy_defeated', label: 'Enemy Defeated' },
								{ value: 'item_obtained', label: 'Item Obtained' },
								{ value: 'complication', label: 'Complication' },
								{ value: 'injury', label: 'Injury' },
								{ value: 'consequence', label: 'Consequence' },
								{ value: 'discovery', label: 'Discovery' },
							],
						},
						{ name: 'description', label: 'Description', type: 'text', required: true },
					],
					displayFields: ['consequence_type', 'description'],
				},
				session_events: {
					label: 'Session Events',
					requiresCampaign: true,
					fields: [
						{ name: 'session_id', label: 'Session', type: 'reference', table: 'sessions', required: true },
						{ name: 'event_order', label: 'Event Order', type: 'number', required: true, min: 1 },
						{
							name: 'event_type',
							label: 'Event Type',
							type: 'select',
							required: true,
							options: [
								{ value: 'npc_introduced', label: 'NPC Introduced' },
								{ value: 'npc_encountered', label: 'NPC Encountered' },
								{ value: 'npc_died', label: 'NPC Died' },
								{ value: 'npc_relocated', label: 'NPC Relocated' },
								{ value: 'npc_joined_faction', label: 'NPC Joined Faction' },
								{ value: 'npc_left_faction', label: 'NPC Left Faction' },
								{ value: 'location_discovered', label: 'Location Discovered' },
								{ value: 'quest_started', label: 'Quest Started' },
								{ value: 'quest_completed', label: 'Quest Completed' },
								{ value: 'encounter_fought', label: 'Encounter Fought' },
								{ value: 'story_event', label: 'Story Event' },
								{ value: 'custom', label: 'Custom' },
							],
						},
						{ name: 'title', label: 'Event Title', type: 'text', required: true, fullWidth: true },
						{ name: 'description', label: 'Description', type: 'textarea', fullWidth: true },
						{ name: 'npc_id', label: 'NPC', type: 'reference', table: 'npcs' },
						{ name: 'location_id', label: 'Location', type: 'reference', table: 'locations' },
						{ name: 'quest_id', label: 'Quest', type: 'reference', table: 'quests' },
						{ name: 'encounter_id', label: 'Encounter', type: 'reference', table: 'encounters' },
						{ name: 'faction_id', label: 'Faction', type: 'reference', table: 'factions' },
						{ name: 'character_id', label: 'Character', type: 'reference', table: 'characters' },
						{ name: 'event_data', label: 'Event Data', type: 'json', fullWidth: true },
					],
					displayFields: ['event_type', 'title', 'event_order'],
				},
			};

			const app = {
				supabase: null,
				currentCampaign: null,
				currentTable: 'campaigns',
				editingId: null,
				data: {},

				async connectSupabase() {
					const url = document.getElementById('supabaseUrl').value.trim();
					const key = document.getElementById('supabaseKey').value.trim();

					if (!url || !key) {
						this.showMessage('Please enter both URL and API key', 'error');
						return;
					}

					try {
						this.supabase = window.supabase.createClient(url, key);
						const { error } = await this.supabase.from('campaigns').select('count');
						if (error) throw error;

						document.getElementById('configSection').style.display = 'none';
						document.getElementById('mainContent').classList.remove('hidden');

						await this.loadAllData();
						this.renderTabs();
						this.switchTab('campaigns');
						this.showMessage('Connected successfully!', 'success');
					} catch (error) {
						this.showMessage('Connection failed: ' + error.message, 'error');
					}
				},

				async loadAllData() {
					const tables = Object.keys(SCHEMA);
					const promises = tables.map((table) => this.supabase.from(table).select('*'));

					const results = await Promise.all(promises);
					tables.forEach((table, i) => {
						this.data[table] = results[i].data || [];
					});

					this.updateCampaignSelector();
				},

				updateCampaignSelector() {
					const select = document.getElementById('campaignSelect');
					select.innerHTML =
						'<option value="">-- Select a campaign --</option>' +
						this.data.campaigns.map((c) => `<option value="${c.id}">Campaign ${c.campaign_id}</option>`).join('');
				},

				setCampaign(campaignId) {
					this.currentCampaign = campaignId;
					if (SCHEMA[this.currentTable].requiresCampaign) {
						this.switchTab(this.currentTable);
					}
				},

				renderTabs() {
					const tabsContainer = document.getElementById('tabs');
					tabsContainer.innerHTML = Object.keys(SCHEMA)
						.map((table) => `<div class="tab" onclick="app.switchTab('${table}')">${SCHEMA[table].label}</div>`)
						.join('');
				},

				switchTab(tableName) {
					this.currentTable = tableName;
					this.editingId = null;

					document.querySelectorAll('.tab').forEach((tab, i) => {
						tab.classList.toggle('active', Object.keys(SCHEMA)[i] === tableName);
					});

					const schema = SCHEMA[tableName];
					if (schema.requiresCampaign && !this.currentCampaign) {
						document.getElementById('formContainer').innerHTML = '<p>Please select a campaign first.</p>';
						return;
					}

					this.renderForm();
				},

				renderForm() {
					const schema = SCHEMA[this.currentTable];
					const container = document.getElementById('formContainer');

					const formHtml = `
                    <h2 id="formTitle">${this.editingId ? 'Edit' : 'Add New'} ${schema.label.slice(0, -1)}</h2>
                    <form id="mainForm" onsubmit="app.handleSubmit(event)">
                        <input type="hidden" id="editId" value="${this.editingId || ''}">
                        <div class="form-grid">
                            ${schema.fields.map((field) => this.renderField(field)).join('')}
                        </div>
                        <button type="submit">${this.editingId ? 'Update' : 'Create'}</button>
                        ${this.editingId ? '<button type="button" onclick="app.cancelEdit()">Cancel</button>' : ''}
                    </form>
                    ${this.renderDataTable()}
                `;

					container.innerHTML = formHtml;
				},

				renderField(field) {
					const fullWidth = field.fullWidth ? 'full-width' : '';
					let input = '';

					if (field.type === 'select') {
						input = `<select id="${field.name}" name="${field.name}" ${field.required ? 'required' : ''}>
                        ${field.options.map((opt) => `<option value="${opt.value}">${opt.label}</option>`).join('')}
                    </select>`;
					} else if (field.type === 'reference') {
						const refData = this.data[field.table] || [];
						const filtered = this.currentCampaign
							? refData.filter((item) => item.campaign_id === this.currentCampaign)
							: refData;
						input = `<select id="${field.name}" name="${field.name}" ${field.required ? 'required' : ''}>
                        <option value="">None</option>
                        ${filtered
													.map((item) => {
														const label = item.name || item.title || item.combatant_name || `Item ${item.id}`;
														return `<option value="${item.id}">${label}</option>`;
													})
													.join('')}
                    </select>`;
					} else if (field.type === 'textarea') {
						input = `<textarea id="${field.name}" name="${field.name}" 
                        ${field.required ? 'required' : ''} 
                        ${field.rows ? `rows="${field.rows}"` : ''}
                        ${field.placeholder ? `placeholder="${field.placeholder}"` : ''}
                        class="${field.type === 'json' ? 'json-editor' : ''}"></textarea>`;
					} else if (field.type === 'json') {
						input = `<textarea id="${field.name}" name="${field.name}" 
                        class="json-editor" 
                        placeholder='${field.placeholder || '{"key": "value"}'}'></textarea>`;
					} else {
						input = `<input type="${field.type}" id="${field.name}" name="${field.name}" 
                        ${field.required ? 'required' : ''}
                        ${field.min ? `min="${field.min}"` : ''}
                        ${field.max ? `max="${field.max}"` : ''}
                        ${field.placeholder ? `placeholder="${field.placeholder}"` : ''}>`;
					}

					return `
                    <div class="form-group ${fullWidth}">
                        <label for="${field.name}">${field.label}${field.required ? ' *' : ''}</label>
                        ${input}
                        ${field.helpText ? `<span class="help-text">${field.helpText}</span>` : ''}
                    </div>
                `;
				},

				renderDataTable() {
					const schema = SCHEMA[this.currentTable];
					let records = this.data[this.currentTable] || [];

					if (schema.requiresCampaign && this.currentCampaign) {
						records = records.filter((r) => r.campaign_id === this.currentCampaign);
					}

					if (records.length === 0) {
						return '<p style="margin-top: 30px; color: #888;">No records yet.</p>';
					}

					const displayFields = schema.displayFields || ['id', 'name'];

					return `
                    <h3 style="margin-top: 40px;">Existing ${schema.label}</h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                ${displayFields.map((field) => `<th>${this.formatFieldName(field)}</th>`).join('')}
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${records
															.map(
																(record) => `
                                <tr>
                                    ${displayFields
																			.map((field) => `<td>${this.formatValue(record[field], field)}</td>`)
																			.join('')}
                                    <td>
                                        <button class="action-btn edit" onclick='app.editRecord(${JSON.stringify(
																					record
																				)})'>Edit</button>
                                        <button class="action-btn delete" onclick='app.deleteRecord("${
																					record.id
																				}", "${this.getRecordName(record)}")'>Delete</button>
                                    </td>
                                </tr>
                            `
															)
															.join('')}
                        </tbody>
                    </table>
                `;
				},

				formatFieldName(field) {
					return field.replace(/_/g, ' ').replace(/\b\w/g, (l) => l.toUpperCase());
				},

				formatValue(value, field) {
					if (value === null || value === undefined) return '-';
					if (field === 'created_at' || field.includes('_date')) {
						return new Date(value).toLocaleDateString();
					}
					if (typeof value === 'object') {
						return JSON.stringify(value);
					}
					return value;
				},

				getRecordName(record) {
					return record.name || record.title || record.combatant_name || `Record ${record.id}`;
				},

				editRecord(record) {
					this.editingId = record.id;
					this.renderForm();

					// Populate form fields
					Object.keys(record).forEach((key) => {
						const field = document.getElementById(key);
						if (field) {
							if (typeof record[key] === 'object' && record[key] !== null) {
								field.value = JSON.stringify(record[key], null, 2);
							} else if (typeof record[key] === 'boolean') {
								field.value = record[key].toString();
							} else if (record[key] !== null) {
								field.value = record[key];
							}
						}
					});

					// Scroll to form
					document.getElementById('mainForm').scrollIntoView({ behavior: 'smooth' });
				},

				cancelEdit() {
					this.editingId = null;
					this.renderForm();
				},

				async handleSubmit(event) {
					event.preventDefault();
					const formData = new FormData(event.target);
					const data = {};
					const schema = SCHEMA[this.currentTable];
					const editId = this.editingId;

					// Add campaign_id if required
					if (schema.requiresCampaign && this.currentCampaign) {
						data.campaign_id = this.currentCampaign;
					}

					// Process form data
					for (let [key, value] of formData.entries()) {
						if (key === 'editId') continue;

						const field = schema.fields.find((f) => f.name === key);

						if (value === '') {
							data[key] = null;
						} else if (field?.type === 'json') {
							try {
								data[key] = value ? JSON.parse(value) : null;
							} catch (e) {
								this.showMessage(`Invalid JSON in ${key}: ${e.message}`, 'error');
								return;
							}
						} else if (field?.type === 'number') {
							data[key] = value ? parseFloat(value) : null;
						} else if (key === 'is_active') {
							data[key] = value === 'true';
						} else {
							data[key] = value;
						}
					}

					// Remove null/empty foreign keys
					Object.keys(data).forEach((key) => {
						if (data[key] === null && key.includes('_id')) {
							delete data[key];
						}
					});

					try {
						let result, error;

						if (editId) {
							({ data: result, error } = await this.supabase
								.from(this.currentTable)
								.update(data)
								.eq('id', editId)
								.select());
							this.showMessage(`‚úÖ Successfully updated!`, 'success');
						} else {
							({ data: result, error } = await this.supabase.from(this.currentTable).insert([data]).select());
							this.showMessage(`‚úÖ Successfully created!`, 'success');
						}

						if (error) throw error;

						await this.loadAllData();

						// Auto-select newly created campaign
						if (this.currentTable === 'campaigns' && result && result[0] && !editId) {
							document.getElementById('campaignSelect').value = result[0].id;
							this.currentCampaign = result[0].id;
						}

						this.editingId = null;
						this.renderForm();
					} catch (error) {
						this.showMessage(`‚ùå Error: ${error.message}`, 'error');
						console.error('Submission error:', error);
					}
				},

				async deleteRecord(id, name) {
					if (!confirm(`Are you sure you want to delete "${name}"? This cannot be undone.`)) {
						return;
					}

					try {
						const { error } = await this.supabase.from(this.currentTable).delete().eq('id', id);

						if (error) throw error;

						this.showMessage(`‚úÖ Successfully deleted ${name}!`, 'success');
						await this.loadAllData();
						this.renderForm();
					} catch (error) {
						this.showMessage(`‚ùå Error deleting: ${error.message}`, 'error');
					}
				},

				showMessage(text, type) {
					const msg = document.getElementById('message');
					msg.textContent = text;
					msg.className = `message ${type}`;
					msg.style.display = 'block';
					setTimeout(() => (msg.style.display = 'none'), 5000);
				},
			};
		</script>
	</body>
</html>
